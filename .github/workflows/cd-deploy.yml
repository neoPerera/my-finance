name: CD - Deploy to Server

on:
  workflow_run:
    workflows: ["CI - Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ Deploy to Server
    runs-on: ubuntu-latest

    # Run only if CI was successful, or it's a manual dispatch
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üè∑Ô∏è Set TAG_NAME based on trigger
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
            echo "Manually triggered on tag: $TAG"
            echo "TAG_NAME=$TAG" >> $GITHUB_ENV
          else
            echo "TAG_NAME=$(echo '${{ github.event.workflow_run.head_branch }}' | sed 's|refs/tags/||')" >> $GITHUB_ENV
          fi

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOST_SSH_KEY }}

      - name: üöÄ Deploy over SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.HOST_SSH_USER }}@${{ secrets.HOST_SSH }} << EOF
            echo "Using tag: $TAG_NAME"
            cd /home/ubuntu/docker/myfinance/my-finance

            echo "IMAGE_TAG=$TAG_NAME" > .env

            sudo docker-compose down
            sudo docker-compose pull
            sudo docker-compose up -d
          EOF
        env:
          TAG_NAME: ${{ env.TAG_NAME }}
